class ImagePixelizer {
    constructor() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        
        // Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï - ÌîΩÏÖÄÌôîÎ•º ÏúÑÌï¥ Ïù¥ÎØ∏ÏßÄ Ïä§Î¨¥Îî© ÎπÑÌôúÏÑ±Ìôî
        this.ctx.imageSmoothingEnabled = false;
        this.ctx.imageSmoothingQuality = 'low';
        
        // UI ÏöîÏÜåÎì§
        this.uploadBtn = document.getElementById('uploadBtn');
        this.imageInput = document.getElementById('imageInput');
        this.pasteBtn = document.getElementById('pasteBtn');
        this.originalBtn = document.getElementById('originalBtn');
        this.pixelBtn = document.getElementById('pixelBtn');
        this.noGridBtn = document.getElementById('noGridBtn');
        this.gridBtn = document.getElementById('gridBtn');
        this.dotBtn = document.getElementById('dotBtn');
        this.exportBtn = document.getElementById('exportBtn');
        this.exportDropdown = document.getElementById('exportDropdown');
        this.downloadLink = document.getElementById('downloadLink');
        this.toast = document.getElementById('toast');
        
        // Î™®Î∞îÏùº UI ÏöîÏÜåÎì§
        this.mobileControls = document.getElementById('mobileControls');
        this.mobileUploadBtn = document.getElementById('mobileUploadBtn');
        this.mobilePasteBtn = document.getElementById('mobilePasteBtn');
        this.mobileModeBtn = document.getElementById('mobileModeBtn');
        this.mobileGridBtn = document.getElementById('mobileGridBtn');
        this.mobileEffectBtn = document.getElementById('mobileEffectBtn');
        this.mobilePixelSlider = document.getElementById('mobilePixelSlider');
        this.mobilePixelValue = document.getElementById('mobilePixelValue');
        this.mobileExportBtn = document.getElementById('mobileExportBtn');
        this.mobileHelpBtn = document.getElementById('mobileHelpBtn');
        
        // ÏÑ§Ï†ï Í∞ùÏ≤¥
        this.settings = {
            pixelSize: 32,
            brightness: 1.0,
            contrast: 1.0,
            saturation: 1.0,
            gridColor: '#dddddd',
            gridWidth: 1,
            dotColor: '#dddddd',
            dotSize: 4,
            exportQuality: 0.9,
            exportScale: 1.0
        };
        
        // ÏÉÅÌÉú Î≥ÄÏàòÎì§
        this.currentMode = 'original'; // 'original' ÎòêÎäî 'pixel'
        this.currentGridMode = 'none'; // 'none', 'grid', 'dot'
        this.originalImage = null;
        this.imageLoaded = false;
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.setupGUI();
        this.resizeCanvas();
        this.showPlaceholder();
    }
    
    setupEventListeners() {
        // ÏóÖÎ°úÎìú Î≤ÑÌäº ÌÅ¥Î¶≠
        this.uploadBtn.addEventListener('click', () => {
            this.imageInput.click();
        });
        
        // ÌååÏùº ÏÑ†ÌÉù
        this.imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                this.loadImage(file);
            }
        });
        
        // ÌÅ¥Î¶ΩÎ≥¥Îìú Î∂ôÏó¨ÎÑ£Í∏∞ Î≤ÑÌäº
        this.pasteBtn.addEventListener('click', () => {
            this.pasteFromClipboard();
        });
        
        // Ï†ÑÏó≠ ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥Î≤§Ìä∏ (Ctrl+V, Cmd+V)
        document.addEventListener('paste', (e) => {
            e.preventDefault();
            this.handlePasteEvent(e);
        });
        
        // Î™®Îìú Ï†ÑÌôò Î≤ÑÌäºÎì§
        this.originalBtn.addEventListener('click', () => {
            this.setMode('original');
        });
        
        this.pixelBtn.addEventListener('click', () => {
            this.setMode('pixel');
        });
        
        // Í∑∏Î¶¨Îìú Î™®Îìú Ï†ÑÌôò Î≤ÑÌäºÎì§
        this.noGridBtn.addEventListener('click', () => {
            this.setGridMode('none');
        });
        
        this.gridBtn.addEventListener('click', () => {
            this.setGridMode('grid');
        });
        
        this.dotBtn.addEventListener('click', () => {
            this.setGridMode('dot');
        });
        
        // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº
        this.exportBtn.addEventListener('click', () => {
            this.toggleExportDropdown();
        });
        
        // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏòµÏÖòÎì§
        this.exportDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('export-option')) {
                const format = e.target.dataset.format;
                this.exportImage(format);
                this.hideExportDropdown();
            }
        });
        
        // ÎìúÎ°≠Îã§Ïö¥ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', (e) => {
            if (!this.exportBtn.contains(e.target) && !this.exportDropdown.contains(e.target)) {
                this.hideExportDropdown();
            }
        });
        
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à
        window.addEventListener('resize', () => {
            this.resizeCanvas();
            if (this.imageLoaded) {
                this.renderImage();
            } else {
                this.showPlaceholder();
            }
        });
        
        // Î™®Î∞îÏùº ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ ÏßÄÏõê
        this.setupTouchEvents();
        
        // Î™®Î∞îÏùºÏóêÏÑú ÌôîÎ©¥ Î∞©Ìñ• Î≥ÄÍ≤Ω Í∞êÏßÄ
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                this.resizeCanvas();
                if (this.imageLoaded) {
                    this.renderImage();
                } else {
                    this.showPlaceholder();
                }
            }, 100);
        });
        
        // Î™®Î∞îÏùº Ïª®Ìä∏Î°§ Ìå®ÎÑê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        this.setupMobileControls();
    }
    
    setupMobileControls() {
        // Î™®Î∞îÏùº ÏóÖÎ°úÎìú Î≤ÑÌäº
        this.mobileUploadBtn.addEventListener('click', () => {
            this.imageInput.click();
        });
        
        // Î™®Î∞îÏùº Î∂ôÏó¨ÎÑ£Í∏∞ Î≤ÑÌäº
        this.mobilePasteBtn.addEventListener('click', () => {
            this.pasteFromClipboard();
        });
        
        // Î™®Î∞îÏùº Î™®Îìú Ï†ÑÌôò Î≤ÑÌäº
        this.mobileModeBtn.addEventListener('click', () => {
            this.toggleMode();
        });
        
        // Î™®Î∞îÏùº Í∑∏Î¶¨Îìú Î™®Îìú Î≤ÑÌäº
        this.mobileGridBtn.addEventListener('click', () => {
            this.cycleGridMode();
        });
        
        // Î™®Î∞îÏùº Ìö®Í≥º Î≥ÄÍ≤Ω Î≤ÑÌäº
        this.mobileEffectBtn.addEventListener('click', () => {
            this.cycleImageEffect();
        });
        
        // Î™®Î∞îÏùº ÌîΩÏÖÄ ÌÅ¨Í∏∞ Ïä¨ÎùºÏù¥Îçî
        this.mobilePixelSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            this.settings.pixelSize = value;
            this.mobilePixelValue.textContent = value;
            
            if (this.imageLoaded && this.currentMode === 'pixel') {
                this.renderImage();
            }
        });
        
        // Î™®Î∞îÏùº ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº
        this.mobileExportBtn.addEventListener('click', () => {
            this.showMobileExportOptions();
        });
        
        // Î™®Î∞îÏùº ÎèÑÏõÄÎßê Î≤ÑÌäº
        this.mobileHelpBtn.addEventListener('click', () => {
            this.showMobileHelp();
        });
        
        // Ï¥àÍ∏∞ Ïä¨ÎùºÏù¥Îçî Í∞í ÏÑ§Ï†ï
        this.mobilePixelSlider.value = this.settings.pixelSize;
        this.mobilePixelValue.textContent = this.settings.pixelSize;
    }
    
    showMobileExportOptions() {
        const options = [
            { format: 'png', label: 'PNGÎ°ú Ï†ÄÏû•' },
            { format: 'jpeg', label: 'JPEGÎ°ú Ï†ÄÏû•' },
            { format: 'webp', label: 'WebPÎ°ú Ï†ÄÏû•' },
            { format: 'svg', label: 'SVGÎ°ú Ï†ÄÏû•' }
        ];
        
        const message = options.map(option => 
            `${option.label}`
        ).join('\n');
        
        if (confirm('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÌòïÏãùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:\n\n' + message + '\n\nÌôïÏù∏ÏùÑ ÎàÑÎ•¥Î©¥ PNGÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.')) {
            this.exportImage('png');
        }
    }
    
    showMobileHelp() {
        const helpText = `
üì± Î™®Î∞îÏùº ÏÇ¨Ïö©Î≤ï:

üëÜ ÌÑ∞Ïπò Ï†úÏä§Ï≤ò:
‚Ä¢ ÎçîÎ∏î ÌÉ≠: ÏõêÎ≥∏/ÌîΩÏÖÄ Î™®Îìú Ï†ÑÌôò
‚Ä¢ ÏôºÏ™Ω Ïä§ÏôÄÏù¥ÌîÑ: Í∑∏Î¶¨Îìú Î™®Îìú Î≥ÄÍ≤Ω
‚Ä¢ Ïò§Î•∏Ï™Ω Ïä§ÏôÄÏù¥ÌîÑ: Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º Î≥ÄÍ≤Ω

üéõÔ∏è Ïª®Ìä∏Î°§ Ìå®ÎÑê:
‚Ä¢ ÏõêÎ≥∏/ÌîΩÏÖÄ: Î™®Îìú Ï†ÑÌôò
‚Ä¢ Í∑∏Î¶¨Îìú Î™®Îìú: Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
‚Ä¢ Ìö®Í≥º Î≥ÄÍ≤Ω: Î∞ùÍ∏∞/ÎåÄÎπÑ/Ï±ÑÎèÑ Ï°∞Ï†ï
‚Ä¢ ÌîΩÏÖÄ ÌÅ¨Í∏∞: Ïä¨ÎùºÏù¥ÎçîÎ°ú Ï°∞Ï†ï
‚Ä¢ ÎÇ¥Î≥¥ÎÇ¥Í∏∞: Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•
‚Ä¢ ÎèÑÏõÄÎßê: Ïù¥ Î©îÏãúÏßÄ ÌëúÏãú

üì∏ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú:
‚Ä¢ "Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú" Î≤ÑÌäº ÏÇ¨Ïö©
‚Ä¢ ÎòêÎäî ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóêÏÑú Î∂ôÏó¨ÎÑ£Í∏∞
        `;
        
        alert(helpText);
    }
    
    setupTouchEvents() {
        // ÌÑ∞Ïπò Ï†úÏä§Ï≤ò Î≥ÄÏàòÎì§
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.touchEndX = 0;
        this.touchEndY = 0;
        this.lastTouchTime = 0;
        this.touchCount = 0;
        
        // Ï∫îÎ≤ÑÏä§ ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleTouchStart(e);
        }, { passive: false });
        
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            this.handleTouchMove(e);
        }, { passive: false });
        
        this.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.handleTouchEnd(e);
        }, { passive: false });
        
        // Î™®Î∞îÏùºÏóêÏÑú ÎçîÎ∏î ÌÉ≠ÏúºÎ°ú Î™®Îìú Ï†ÑÌôò
        this.canvas.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - this.lastTouchTime;
            
            if (timeDiff < 300 && timeDiff > 0) {
                // ÎçîÎ∏î ÌÉ≠ Í∞êÏßÄ
                this.toggleMode();
            }
            
            this.lastTouchTime = currentTime;
        });
        
        // Î™®Î∞îÏùºÏóêÏÑú Ïä§ÏôÄÏù¥ÌîÑ Ï†úÏä§Ï≤ò
        let startX = 0;
        let startY = 0;
        
        this.canvas.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });
        
        this.canvas.addEventListener('touchend', (e) => {
            if (!startX || !startY) return;
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            // ÏàòÌèâ Ïä§ÏôÄÏù¥ÌîÑ Í∞êÏßÄ (ÏµúÏÜå 50px)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // ÏôºÏ™Ω Ïä§ÏôÄÏù¥ÌîÑ - Í∑∏Î¶¨Îìú Î™®Îìú Î≥ÄÍ≤Ω
                    this.cycleGridMode();
                } else {
                    // Ïò§Î•∏Ï™Ω Ïä§ÏôÄÏù¥ÌîÑ - Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º Ï°∞Ï†ï
                    this.cycleImageEffect();
                }
            }
            
            startX = 0;
            startY = 0;
        });
    }
    
    handleTouchStart(e) {
        this.touchStartX = e.touches[0].clientX;
        this.touchStartY = e.touches[0].clientY;
    }
    
    handleTouchMove(e) {
        // ÌÑ∞Ïπò Ïù¥Îèô Ï§ë Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
        e.preventDefault();
    }
    
    handleTouchEnd(e) {
        this.touchEndX = e.changedTouches[0].clientX;
        this.touchEndY = e.changedTouches[0].clientY;
    }
    
    toggleMode() {
        if (this.currentMode === 'original') {
            this.setMode('pixel');
        } else {
            this.setMode('original');
        }
    }
    
    cycleGridMode() {
        const modes = ['none', 'grid', 'dot'];
        const currentIndex = modes.indexOf(this.currentGridMode);
        const nextIndex = (currentIndex + 1) % modes.length;
        this.setGridMode(modes[nextIndex]);
    }
    
    cycleImageEffect() {
        // Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º ÏàúÌôò (Î∞ùÍ∏∞, ÎåÄÎπÑ, Ï±ÑÎèÑ)
        const effects = [
            { brightness: 1.0, contrast: 1.0, saturation: 1.0 },
            { brightness: 1.2, contrast: 1.1, saturation: 1.0 },
            { brightness: 0.8, contrast: 1.2, saturation: 1.1 },
            { brightness: 1.1, contrast: 0.9, saturation: 1.2 }
        ];
        
        const currentEffect = `${this.settings.brightness}-${this.settings.contrast}-${this.settings.saturation}`;
        let nextIndex = 0;
        
        for (let i = 0; i < effects.length; i++) {
            const effect = effects[i];
            const effectString = `${effect.brightness}-${effect.contrast}-${effect.saturation}`;
            if (effectString === currentEffect) {
                nextIndex = (i + 1) % effects.length;
                break;
            }
        }
        
        const nextEffect = effects[nextIndex];
        this.settings.brightness = nextEffect.brightness;
        this.settings.contrast = nextEffect.contrast;
        this.settings.saturation = nextEffect.saturation;
        
        if (this.imageLoaded) {
            this.renderImage();
        }
        
        this.showMessage(`Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º Î≥ÄÍ≤Ω: Î∞ùÍ∏∞ ${nextEffect.brightness}, ÎåÄÎπÑ ${nextEffect.contrast}, Ï±ÑÎèÑ ${nextEffect.saturation}`);
    }
    
    setupGUI() {
        const gui = new dat.GUI();
        
        // ÌîΩÏÖÄÌôî ÏÑ§Ï†ï
        const pixelFolder = gui.addFolder('ÌîΩÏÖÄÌôî ÏÑ§Ï†ï');
        pixelFolder.add(this.settings, 'pixelSize', 1, 64)
                  .name('ÌîΩÏÖÄ ÌÅ¨Í∏∞')
                  .onChange(() => {
                      if (this.imageLoaded && this.currentMode === 'pixel') {
                          this.renderImage();
                      }
                  });
        
        // Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º ÏÑ§Ï†ï
        const effectsFolder = gui.addFolder('Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º');
        effectsFolder.add(this.settings, 'brightness', 0.1, 3.0)
                    .name('Î∞ùÍ∏∞')
                    .onChange(() => {
                        if (this.imageLoaded) {
                            this.renderImage();
                        }
                    });
        effectsFolder.add(this.settings, 'contrast', 0.1, 3.0)
                    .name('ÎåÄÎπÑ')
                    .onChange(() => {
                        if (this.imageLoaded) {
                            this.renderImage();
                        }
                    });
        effectsFolder.add(this.settings, 'saturation', 0.0, 3.0)
                    .name('Ï±ÑÎèÑ')
                    .onChange(() => {
                        if (this.imageLoaded) {
                            this.renderImage();
                        }
                    });
        
        // Í∑∏Î¶¨Îìú ÏÑ§Ï†ï
        const gridFolder = gui.addFolder('Í∑∏Î¶¨Îìú ÏÑ§Ï†ï');
        gridFolder.addColor(this.settings, 'gridColor')
                  .name('Í∑∏Î¶¨Îìú ÏÉâÏÉÅ')
                  .onChange(() => {
                      if (this.imageLoaded && this.currentMode === 'pixel') {
                          this.renderImage();
                      }
                  });
        gridFolder.add(this.settings, 'gridWidth', 0.5, 5)
                  .name('Í∑∏Î¶¨Îìú ÎëêÍªò')
                  .onChange(() => {
                      if (this.imageLoaded && this.currentMode === 'pixel') {
                          this.renderImage();
                      }
                  });
        
        // ÎèÑÌä∏ ÏÑ§Ï†ï
        const dotFolder = gui.addFolder('ÎèÑÌä∏ ÏÑ§Ï†ï');
        dotFolder.addColor(this.settings, 'dotColor')
                 .name('ÎèÑÌä∏ ÏÉâÏÉÅ')
                 .onChange(() => {
                     if (this.imageLoaded && this.currentMode === 'pixel') {
                         this.renderImage();
                     }
                 });
        dotFolder.add(this.settings, 'dotSize', 1, 20)
                 .name('ÎèÑÌä∏ ÌÅ¨Í∏∞')
                 .onChange(() => {
                     if (this.imageLoaded && this.currentMode === 'pixel') {
                         this.renderImage();
                     }
                 });
        
        // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏÑ§Ï†ï
        const exportFolder = gui.addFolder('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏÑ§Ï†ï');
        exportFolder.add(this.settings, 'exportQuality', 0.1, 1.0)
                    .name('ÌíàÏßà')
                    .onChange(() => {
                        // ÌíàÏßà Î≥ÄÍ≤ΩÏùÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏãúÏóêÎßå Ï†ÅÏö©Îê®
                    });
        exportFolder.add(this.settings, 'exportScale', 0.5, 4.0)
                    .name('ÌÅ¨Í∏∞ Î∞∞Ïú®')
                    .onChange(() => {
                        // ÌÅ¨Í∏∞ Î∞∞Ïú® Î≥ÄÍ≤ΩÏùÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏãúÏóêÎßå Ï†ÅÏö©Îê®
                    });
        
        pixelFolder.open();
        effectsFolder.open();
        gridFolder.open();
        dotFolder.open();
        exportFolder.open();
    }
    
    loadImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                this.originalImage = img;
                this.imageLoaded = true;
                this.resizeCanvas();
                this.renderImage();
                this.showMessage('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    async pasteFromClipboard() {
        try {
            const clipboardItems = await navigator.clipboard.read();
            for (const clipboardItem of clipboardItems) {
                for (const type of clipboardItem.types) {
                    if (type.startsWith('image/')) {
                        const blob = await clipboardItem.getType(type);
                        this.loadImageFromBlob(blob);
                        return;
                    }
                }
            }
            this.showMessage('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
        } catch (error) {
            console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Ï†ëÍ∑º Ïò§Î•ò:', error);
            this.showMessage('ÌÅ¥Î¶ΩÎ≥¥Îìú Ï†ëÍ∑ºÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
        }
    }
    
    handlePasteEvent(e) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.startsWith('image/')) {
                const blob = items[i].getAsFile();
                this.loadImageFromBlob(blob);
                return;
            }
        }
        this.showMessage('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
    }
    
    loadImageFromBlob(blob) {
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
            this.originalImage = img;
            this.imageLoaded = true;
            this.resizeCanvas();
            this.renderImage();
            URL.revokeObjectURL(url); // Î©îÎ™®Î¶¨ Ï†ïÎ¶¨
            this.showMessage('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
        };
        img.src = url;
    }
    
    showMessage(message, type = 'info') {
        this.toast.textContent = message;
        this.toast.className = `toast show ${type}`;
        
        // 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Ïà®Í∏∞Í∏∞
        setTimeout(() => {
            this.toast.classList.remove('show');
        }, 3000);
    }
    
    setMode(mode) {
        this.currentMode = mode;
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        this.originalBtn.classList.toggle('active', mode === 'original');
        this.pixelBtn.classList.toggle('active', mode === 'pixel');
        
        // Î™®Î∞îÏùº Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        if (this.mobileModeBtn) {
            this.mobileModeBtn.textContent = mode === 'original' ? 'ÌîΩÏÖÄÌôî' : 'ÏõêÎ≥∏';
        }
        
        // Ïù¥ÎØ∏ÏßÄ Î†åÎçîÎßÅ
        if (this.imageLoaded) {
            this.renderImage();
        }
        
        // Î™®Îìú Î≥ÄÍ≤Ω Î©îÏãúÏßÄ
        const modeText = mode === 'original' ? 'ÏõêÎ≥∏' : 'ÌîΩÏÖÄÌôî';
        this.showMessage(`${modeText} Î™®ÎìúÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
    }

    setGridMode(mode) {
        this.currentGridMode = mode;
        
        // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        this.noGridBtn.classList.toggle('active', mode === 'none');
        this.gridBtn.classList.toggle('active', mode === 'grid');
        this.dotBtn.classList.toggle('active', mode === 'dot');
        
        // Î™®Î∞îÏùº Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        if (this.mobileGridBtn) {
            const modeTexts = {
                'none': 'Í∑∏Î¶¨Îìú ÏóÜÏùå',
                'grid': 'Í∑∏Î¶¨Îìú',
                'dot': 'ÎèÑÌä∏'
            };
            this.mobileGridBtn.textContent = modeTexts[mode] || 'Í∑∏Î¶¨Îìú Î™®Îìú';
        }

        // Ïù¥ÎØ∏ÏßÄ Î†åÎçîÎßÅ
        if (this.imageLoaded) {
            this.renderImage();
        }
        
        // Í∑∏Î¶¨Îìú Î™®Îìú Î≥ÄÍ≤Ω Î©îÏãúÏßÄ
        const modeText = mode === 'none' ? 'Í∑∏Î¶¨Îìú ÏóÜÏùå' : mode === 'grid' ? 'Í∑∏Î¶¨Îìú' : 'ÎèÑÌä∏';
        this.showMessage(`${modeText} Î™®ÎìúÎ°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
    }
    
    resizeCanvas() {
        const container = this.canvas.parentElement;
        const maxWidth = container.clientWidth - 40;
        const maxHeight = container.clientHeight - 40;
        
        if (this.originalImage) {
            // Ïù¥ÎØ∏ÏßÄ ÎπÑÏú® Ïú†ÏßÄÌïòÎ©¥ÏÑú Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ï°∞Ï†ï
            const imgRatio = this.originalImage.width / this.originalImage.height;
            const containerRatio = maxWidth / maxHeight;
            
            if (imgRatio > containerRatio) {
                this.canvas.width = maxWidth;
                this.canvas.height = maxWidth / imgRatio;
            } else {
                this.canvas.height = maxHeight;
                this.canvas.width = maxHeight * imgRatio;
            }
        } else {
            // ÌîåÎ†àÏù¥Ïä§ÌôÄÎçîÏö© ÌÅ¨Í∏∞
            this.canvas.width = Math.min(800, maxWidth);
            this.canvas.height = Math.min(600, maxHeight);
        }
    }
    
    showPlaceholder() {
        this.ctx.fillStyle = '#2a2a2a';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.ctx.fillStyle = '#666';
        this.ctx.font = '24px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';
        this.ctx.fillText('Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî', this.canvas.width / 2, this.canvas.height / 2);
        
        this.ctx.font = '16px Arial';
        this.ctx.fillStyle = '#888';
        this.ctx.fillText('ÏúÑÏùò "Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî', this.canvas.width / 2, this.canvas.height / 2 + 40);
    }
    
    renderImage() {
        if (!this.originalImage) return;
        
        // Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶¨Ïñ¥
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        if (this.currentMode === 'original') {
            this.renderOriginalImage();
        } else {
            this.renderPixelatedImage();
        }
    }
    
    renderOriginalImage() {
        // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶¨Í∏∞
        this.ctx.drawImage(this.originalImage, 0, 0, this.canvas.width, this.canvas.height);
        
        // Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º Ï†ÅÏö©
        this.applyImageEffects();
    }
    
    renderPixelatedImage() {
        const pixelSize = this.settings.pixelSize;
        const imgWidth = this.canvas.width;
        const imgHeight = this.canvas.height;
        
        // ÏûÑÏãú Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ± (ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÏö©)
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = imgWidth;
        tempCanvas.height = imgHeight;
        
        // ÏûÑÏãú Ï∫îÎ≤ÑÏä§Ïùò Ïù¥ÎØ∏ÏßÄ Ïä§Î¨¥Îî©ÎèÑ ÎπÑÌôúÏÑ±Ìôî
        tempCtx.imageSmoothingEnabled = false;
        tempCtx.imageSmoothingQuality = 'low';
        
        // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º ÏûÑÏãú Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶¨Í∏∞
        tempCtx.drawImage(this.originalImage, 0, 0, imgWidth, imgHeight);
        
        // Ïù¥ÎØ∏ÏßÄ Ìö®Í≥º Ï†ÅÏö©
        this.applyImageEffects(tempCtx, tempCanvas);
        
        // Ï†ïÌôïÌïú ÌîΩÏÖÄ Î∏îÎ°ù ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
        const scaledDownWidth = Math.ceil(imgWidth / pixelSize);
        const scaledDownHeight = Math.ceil(imgHeight / pixelSize);
        
        // Ïã§Ï†ú ÌîΩÏÖÄ Î∏îÎ°ù ÌÅ¨Í∏∞ (ÎßàÏßÄÎßâ Î∏îÎ°ùÏù¥ ÏûòÎ¶¥ Ïàò ÏûàÏùå)
        const actualPixelWidth = imgWidth / scaledDownWidth;
        const actualPixelHeight = imgHeight / scaledDownHeight;
        
        // Ï∂ïÏÜåÎêú Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
        const scaledCanvas = document.createElement('canvas');
        const scaledCtx = scaledCanvas.getContext('2d');
        scaledCanvas.width = scaledDownWidth;
        scaledCanvas.height = scaledDownHeight;
        
        // Ïù¥ÎØ∏ÏßÄ Ïä§Î¨¥Îî© ÎπÑÌôúÏÑ±Ìôî
        scaledCtx.imageSmoothingEnabled = false;
        scaledCtx.imageSmoothingQuality = 'low';
        
        // ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º Ï∂ïÏÜåÎêú ÌÅ¨Í∏∞Î°ú Í∑∏Î¶¨Í∏∞ (ÌîΩÏÖÄÌôî Ìö®Í≥º)
        scaledCtx.drawImage(tempCanvas, 0, 0, scaledDownWidth, scaledDownHeight);
        
        // Ï∂ïÏÜåÎêú Ïù¥ÎØ∏ÏßÄÎ•º ÏõêÎ≥∏ ÌÅ¨Í∏∞Î°ú ÌôïÎåÄ (ÌîΩÏÖÄÌôî ÏôÑÏÑ±)
        this.ctx.imageSmoothingEnabled = false;
        this.ctx.imageSmoothingQuality = 'low';
        this.ctx.drawImage(scaledCanvas, 0, 0, imgWidth, imgHeight);
        
        // Í∑∏Î¶¨Îìú ÎòêÎäî ÎèÑÌä∏ Í∑∏Î¶¨Í∏∞ (Ïã§Ï†ú ÌîΩÏÖÄ Î∏îÎ°ù ÌÅ¨Í∏∞ ÏÇ¨Ïö©)
        if (this.currentGridMode === 'grid') {
            this.drawGrid(actualPixelWidth, actualPixelHeight, imgWidth, imgHeight, scaledDownWidth, scaledDownHeight);
        } else if (this.currentGridMode === 'dot') {
            this.drawDots(actualPixelWidth, actualPixelHeight, imgWidth, imgHeight, scaledDownWidth, scaledDownHeight);
        }
    }
    
    applyImageEffects(ctx = this.ctx, canvas = this.canvas) {
        const brightness = this.settings.brightness;
        const contrast = this.settings.contrast;
        const saturation = this.settings.saturation;
        
        // Ìö®Í≥ºÍ∞Ä Í∏∞Î≥∏Í∞íÏù¥Î©¥ Ï†ÅÏö©ÌïòÏßÄ ÏïäÏùå
        if (brightness === 1.0 && contrast === 1.0 && saturation === 1.0) {
            return;
        }
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];
            
            // Î∞ùÍ∏∞ Ï°∞Ï†ï
            if (brightness !== 1.0) {
                r = Math.min(255, Math.max(0, r * brightness));
                g = Math.min(255, Math.max(0, g * brightness));
                b = Math.min(255, Math.max(0, b * brightness));
            }
            
            // ÎåÄÎπÑ Ï°∞Ï†ï
            if (contrast !== 1.0) {
                const factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255));
                r = Math.min(255, Math.max(0, factor * (r - 128) + 128));
                g = Math.min(255, Math.max(0, factor * (g - 128) + 128));
                b = Math.min(255, Math.max(0, factor * (b - 128) + 128));
            }
            
            // Ï±ÑÎèÑ Ï°∞Ï†ï
            if (saturation !== 1.0) {
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                r = Math.min(255, Math.max(0, gray + saturation * (r - gray)));
                g = Math.min(255, Math.max(0, gray + saturation * (g - gray)));
                b = Math.min(255, Math.max(0, gray + saturation * (b - gray)));
            }
            
            data[i] = r;
            data[i + 1] = g;
            data[i + 2] = b;
        }
        
        ctx.putImageData(imageData, 0, 0);
    }
    
    drawGrid(actualPixelWidth, actualPixelHeight, imgWidth, imgHeight, scaledDownWidth, scaledDownHeight) {
        this.ctx.strokeStyle = this.settings.gridColor;
        this.ctx.lineWidth = this.settings.gridWidth;
        this.ctx.beginPath();
        
        // ÏÑ∏Î°úÏÑ† Í∑∏Î¶¨Í∏∞ (Ïã§Ï†ú ÌîΩÏÖÄ Î∏îÎ°ù Í≤ΩÍ≥ÑÏóê ÎßûÏ∂§)
        for (let i = 1; i < scaledDownWidth; i++) {
            const x = i * actualPixelWidth;
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, imgHeight);
        }
        
        // Í∞ÄÎ°úÏÑ† Í∑∏Î¶¨Í∏∞ (Ïã§Ï†ú ÌîΩÏÖÄ Î∏îÎ°ù Í≤ΩÍ≥ÑÏóê ÎßûÏ∂§)
        for (let i = 1; i < scaledDownHeight; i++) {
            const y = i * actualPixelHeight;
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(imgWidth, y);
        }
        
        this.ctx.stroke();
    }
    
    drawDots(actualPixelWidth, actualPixelHeight, imgWidth, imgHeight, scaledDownWidth, scaledDownHeight) {
        this.ctx.fillStyle = this.settings.dotColor;
        
        // Í∑∏Î¶¨Îìú ÍµêÏ∞®Ï†êÏóê ÎèÑÌä∏ Í∑∏Î¶¨Í∏∞ (Ïã§Ï†ú ÌîΩÏÖÄ Î∏îÎ°ù Í≤ΩÍ≥ÑÏóê ÎßûÏ∂§)
        for (let i = 1; i < scaledDownHeight; i++) {
            for (let j = 1; j < scaledDownWidth; j++) {
                const x = j * actualPixelWidth;
                const y = i * actualPixelHeight;
                const dotRadius = this.settings.dotSize / 2;
                this.ctx.beginPath();
                this.ctx.arc(x, y, dotRadius, 0, 2 * Math.PI);
                this.ctx.fill();
            }
        }
    }

    toggleExportDropdown() {
        this.exportDropdown.classList.toggle('show');
    }
    
    hideExportDropdown() {
        this.exportDropdown.classList.remove('show');
    }
    
    exportImage(format) {
        if (!this.imageLoaded) {
            this.showMessage('ÎÇ¥Î≥¥ÎÇº Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
            return;
        }
        
        try {
            let dataUrl;
            let filename;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            
            switch (format) {
                case 'png':
                    dataUrl = this.canvas.toDataURL('image/png');
                    filename = `pixelated-image-${timestamp}.png`;
                    break;
                    
                case 'jpeg':
                    dataUrl = this.canvas.toDataURL('image/jpeg', this.settings.exportQuality);
                    filename = `pixelated-image-${timestamp}.jpg`;
                    break;
                    
                case 'webp':
                    dataUrl = this.canvas.toDataURL('image/webp', this.settings.exportQuality);
                    filename = `pixelated-image-${timestamp}.webp`;
                    break;
                    
                case 'svg':
                    dataUrl = this.canvasToSVG();
                    filename = `pixelated-image-${timestamp}.svg`;
                    break;
                    
                default:
                    this.showMessage('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Ìè¨Îß∑ÏûÖÎãàÎã§.', 'error');
                    return;
            }
            
            // Í≥†Ìï¥ÏÉÅÎèÑ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
            if (this.settings.exportScale !== 1.0) {
                dataUrl = this.exportHighResolution(format);
            }
            
            this.downloadFile(dataUrl, filename);
            this.showMessage(`${format.toUpperCase()} ÌòïÏãùÏúºÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!`, 'success');
            
        } catch (error) {
            console.error('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïò§Î•ò:', error);
            this.showMessage('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    
    exportHighResolution(format) {
        const scale = this.settings.exportScale;
        const originalWidth = this.canvas.width;
        const originalHeight = this.canvas.height;
        
        // Í≥†Ìï¥ÏÉÅÎèÑ Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
        const highResCanvas = document.createElement('canvas');
        const highResCtx = highResCanvas.getContext('2d');
        highResCanvas.width = originalWidth * scale;
        highResCanvas.height = originalHeight * scale;
        
        // Í≥†Ìï¥ÏÉÅÎèÑ Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
        highResCtx.imageSmoothingEnabled = false;
        highResCtx.imageSmoothingQuality = 'low';
        
        // ÌòÑÏû¨ Ï∫îÎ≤ÑÏä§ ÎÇ¥Ïö©ÏùÑ Í≥†Ìï¥ÏÉÅÎèÑÎ°ú Î≥µÏÇ¨
        highResCtx.drawImage(this.canvas, 0, 0, highResCanvas.width, highResCanvas.height);
        
        // Í≥†Ìï¥ÏÉÅÎèÑ Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ URL ÏÉùÏÑ±
        switch (format) {
            case 'png':
                return highResCanvas.toDataURL('image/png');
            case 'jpeg':
                return highResCanvas.toDataURL('image/jpeg', this.settings.exportQuality);
            case 'webp':
                return highResCanvas.toDataURL('image/webp', this.settings.exportQuality);
            case 'svg':
                return this.canvasToSVG(scale);
            default:
                return highResCanvas.toDataURL('image/png');
        }
    }
    
    canvasToSVG(scale = 1.0) {
        const width = this.canvas.width * scale;
        const height = this.canvas.height * scale;
        
        // SVG Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
        const svgData = this.canvas.toDataURL('image/png');
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                <image href="${svgData}" width="${width}" height="${height}"/>
            </svg>
        `;
        
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
    
    downloadFile(dataUrl, filename) {
        this.downloadLink.href = dataUrl;
        this.downloadLink.download = filename;
        this.downloadLink.click();
    }
}

// Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÏãúÏûë
document.addEventListener('DOMContentLoaded', () => {
    new ImagePixelizer();
}); 